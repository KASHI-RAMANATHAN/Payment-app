<!DOCTYPE html>
<html>
    <head>
        <title>Pace | Login Page</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway+Dots&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="public-k/login.css">
        <link rel="icon" href="/LOGO-top.svg" type="vector/svg+xml" /> 
        <link rel="shortcut icon" href="/LOGO-top.svg" type="vector/svg+xml" />
        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
        <style>
            @font-face {
                font-family: 'Strjmono';
                src: url('fonts for project/Strjmono.otf') format('opentype');
            }
        </style>
    </head>
    <body>
        <div class="header">
            <img src="LOGO.jpeg" class="logo">
            <div class="hometag" onclick="window.location.href='homepage.html'">Home</div>
            <div class="personal-tag">Dashboard</div>
            <div class="useful-info-tag-container">
                <div class="useful-info-tag">Policies</div>
                <div class="policy-dropdown">
                    <a href="refund-policy.html" class="dropdown-link">Refund Policy</a>
                    <a href="shipping-policy.html" class="dropdown-link">Shipping Policy</a>
                    <a href="contact-us.html" class="dropdown-link">Contact Us</a>
                </div>
            </div>
            <!-- <div class="useful-info-tag">Useful Info</div> -->
            <button class="login-button">Log In</button>
        </div>
        
        <div class="page-content">
            <div class="login-box">
                <div class="username-field">
                    <img src="svgs/Frame 19.svg" class="profile">
                    <input type="email" id="email" placeholder="Email" class="username-box">
                </div>
                <div class="password-field">
                    <img src="svgs/Frame 18.svg" class="profile">
                    <input type="password" id="password" placeholder="Password" class="username-box">
                </div>

                <div id="error-message" class="error-message"></div>
                <div id="success-message" class="success-message" style="display: none;"></div>

                <!-- Verification Section -->
                <div id="verification-section" class="verification-section" style="display: none; margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">Email Verification Required</h4>
                    <p style="margin: 0 0 10px 0; color: #666;">We've sent a verification email to <span id="verification-email" style="font-weight: bold;"></span></p>
                    <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">
                        Please check your inbox (and spam folder). Once verified, refresh this page and log in again.
                    </p>
                    <button type="button" id="resend-btn" class="resend-btn" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Resend Verification Email
                    </button>
                    <p style="margin: 10px 0 0 0; font-size: 12px; color: #6c757d;">
                        <a href="#" onclick="showForgotEmail()" style="color: #007bff; text-decoration: none;">I don't have access to this email</a>
                    </p>
                </div>

                <button class="login" id="login-btn">LOGIN</button>
                <button class="google-login">
                    <img src="svgs/google-logo.png" class="glogo">
                    SIGN IN WITH GOOGLE
                </button>
                <button class="googleless-login" onclick="window.location.href='signup-page.html'">
                    SIGN UP
                </button>
            </div>
        </div>
        <div class="footer">
            <div class="footer-left">
                <div class="footer-part-1">
                    <img src="LOGO.jpeg" class="footer-logo">
                    <div class="company-name">
                        Pace
                    </div>
                    <img src="svgs/Line 10.svg" class="line">
                    <div class="company-tegline">
                        A Payment app That simplifies life
                    </div>
                </div>
                <div class="footer-part-2">
                    Get updates on fun stuff you probably want to know about in your inbox.
                </div>
                <div class="footer-part-3">
                    <img src="svgs/twitter.svg" class="twitterf">
                    <img src="svgs/facebook.svg" class="facebookf">
                    <img src="svgs/youtube.svg" class="youtubef">
                    <img src="svgs/instagram.svg" class="instagramf">
                    <img src="svgs/linkedin.svg" class="linkedinf">
                </div>
                <div class="footer-part-4">
                    <div class="left-sec">
                        <ul>
                            <li class="faq">FAQs</li>
                            <li class="support">Support</li>
                            <li class="live-chat">Live Chat</li>
                        </ul>
                    </div>
                    <div class="middle">
                        <ul>
                            <li class="phnumber">
                                <img src="svgs/call.svg" class="call">
                                +91 7010578495
                            </li>
                            <li class="mail">
                                <img src="svgs/mail.svg" class="mailf">
                                <a href="kashiramanathan2@gmail.com" target="_blank" rel="noopener noreferrer">kashiramanathan2@gmail.com</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="footer-right">
                <img src="svgs/bing_generated_qrcode 1.svg" class="qr">
            </div>
        </div>
        <script>
            // âœ… YOUR REAL FIREBASE CONFIG - This will fix the error!
            const firebaseConfig = {
                apiKey: "AIzaSyCxZU0md5obSR4UG5UEemhDbZS6BNXuUAA",
                authDomain: "payment-app-6c1e6.firebaseapp.com",
                projectId: "payment-app-6c1e6",
                storageBucket: "payment-app-6c1e6.firebasestorage.app",
                messagingSenderId: "41084938775",
                appId: "1:41084938775:web:2102d5bed58c1640a58a52",
                measurementId: "G-Q847TSJDDL"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();

            // Check auth state on page load for immediate redirect if already logged in
            auth.onAuthStateChanged((user) => {
                if (user && user.emailVerified) {
                    // User is signed in and verified, store data and redirect
                    localStorage.setItem('user', JSON.stringify({
                        id: user.uid,
                        // displayName is set during signup
                        name: user.displayName || user.email, 
                        email: user.email
                    }));
                    window.location.href = 'profilepage.html';
                }
            });
            document.addEventListener('DOMContentLoaded', function() {
                    const loginButton = document.querySelector('.personal-tag');
                    loginButton.addEventListener('click', function() {
                    window.location.href = 'dashboard.html'; // Replace with your login page file name
                });
            });
            document.addEventListener('DOMContentLoaded', function() {
            const loginBtn = document.getElementById('login-btn');
            const resendBtn = document.getElementById('resend-btn');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            const verificationSection = document.getElementById('verification-section');
            const verificationEmail = document.getElementById('verification-email');

            // Utility functions (Keep your existing ones)
            function showError(message) {
                clearMessages();
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                errorMessage.style.color = '#dc3545';
                verificationSection.style.display = 'none';
            }

            function showSuccess(message) {
                clearMessages();
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                successMessage.style.color = '#28a745';
                verificationSection.style.display = 'none';
            }

            function showMessage(message, color) {
                clearMessages();
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                errorMessage.style.color = color;
            }

            function clearMessages() {
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';
                errorMessage.textContent = '';
                successMessage.textContent = '';
            }
            
            // Login functionality
            loginBtn.addEventListener('click', async function() {
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();

                clearMessages();
                verificationSection.style.display = 'none'; // Hide verification initially

                if (!email || !password) {
                    showError('Please fill in all fields');
                    return;
                }

                loginBtn.disabled = true;
                loginBtn.textContent = 'Logging in...';
                showMessage('Logging in...', '#ffc107');

                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    // Check if email is verified
                    if (!user.emailVerified) {
                        // Show verification section
                        verificationEmail.textContent = email;
                        verificationSection.style.display = 'block';
                        showMessage('Please verify your email before logging in', '#ffc107');
                        
                        // Sign out the unverified user to prevent partial login state
                        await auth.signOut();
                        return;
                    }

                    // Store user data (UID, displayName, email)
                    localStorage.setItem('user', JSON.stringify({
                        id: user.uid,
                        name: user.displayName || user.email, // Use display name or fallback to email
                        email: user.email
                    }));

                    showSuccess('Login successful! Redirecting...');
                    
                    // Auto-redirect after 1.5 seconds
                    setTimeout(() => {
                        window.location.href = 'profilepage.html';
                    }, 1500);

                } catch (error) {
                    console.error('Login error:', error);
                    let errorMsg = 'Login failed';

                    if (error.code.includes('user-not-found') || error.code.includes('wrong-password')) {
                        errorMsg = 'Invalid email or password';
                    } else if (error.code.includes('too-many-requests')) {
                        errorMsg = 'Too many failed attempts. Please try again later';
                    } else {
                        errorMsg = error.message;
                    }

                    showError(errorMsg);
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'LOGIN';
                }
            });

            // Resend verification email logic (Your existing logic is fine, keeping it)
            resendBtn.addEventListener('click', async function() {
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                
                if (!email || !password) {
                    showError('Please enter your email and password');
                    return;
                }

                resendBtn.disabled = true;
                resendBtn.textContent = 'Sending...';
                clearMessages();

                try {
                    // Sign in temporarily to send verification email
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    await user.sendEmailVerification({
                        url: 'http://localhost:5000/login.html',
                        handleCodeInApp: false
                    });

                    await auth.signOut();

                    showMessage('Verification email sent! Check your inbox.', '#28a745');
                    resendBtn.textContent = 'Sent! Check Email';
                    
                    setTimeout(() => {
                        resendBtn.textContent = 'Resend Verification Email';
                        resendBtn.disabled = false;
                    }, 3000);

                } catch (error) {
                    console.error('Resend error:', error);
                    let errorMsg = 'Failed to send verification email. Check your email and password.';
                    showError(errorMsg);
                    resendBtn.textContent = 'Resend Verification Email';
                    resendBtn.disabled = false;
                }
            });

            // Enter key support
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !loginBtn.disabled) {
                    loginBtn.click();
                }
            });

            // Forgot email link handler
            window.showForgotEmail = function() {
                if (confirm("It looks like you don't have access to this email anymore. Would you like to create a new account?")) {
                    window.location.href = 'signup-page.html';
                }
            };
        });
        </script>
    </body>
</html>